<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <meta name="Heritier" content="QT Exam" />
    <meta name="generator" content="Hugo 0.84.0" />
    <title>Index</title>

    <!-- Bootstrap core CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />

    <!-- Custom styles for this template -->
    <link href="dist/css/custom.css" rel="stylesheet" />
    <!-- Datepicker  -->
    <link href="dist/css/google-ui.css" rel="stylesheet" />
    <link href="dist/css/sweetalert.css" rel="stylesheet" />
    <link href="dist/css/dataTables.jqueryui.min.css" rel="stylesheet" />
    <link href="dist/css/jquery.dataTables.min.css" rel="stylesheet" />
    <link href="dist/css/responsive.dataTables.min.css" rel="stylesheet" />
  </head>
  <style>
    .navbar-light {
      background: #0063cf;
      color: white;
      box-shadow: 0 2px 7px #0000004f !important;
    }

    .navbar-light .navbar-brand:focus,
    .navbar-light .navbar-brand:hover {
      color: white !important;
    }

    .navbar-brand {
      color: white !important;
    }
  </style>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light">
      <a class="navbar-brand" href="/index">Tasks Managment</a>
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <a class="navbar-brand" href="#">
          <img
            alt=""
            width="30"
            height="24"
            class="d-inline-block align-text-top user-photo rounded-circle"
          />
          <span class="user-u"></span>
        </a>
      </div>
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/logout"
            ><i class="fa fa-lock"></i>Log out</a
          >
        </li>
      </ul>
    </nav>
    <div class="container col-lg-6">
      <br />
      <br />
      <br />
      <h4 class="registration-form-title">Registration Form</h4>
      <br />
      <div class="row">
        <div class="col-lg-12">
          <div class="profile-pic more2">
            <input type="hidden" id="page-id" value="is-new-record" />
            <input type="hidden" id="profilePictureInput" />
            <!-- <input type="hidden" id="signatureNidInput" > -->
            <div class="avatar-upload" id="imageUploadArea">
              <div class="avatar-edit">
                <input
                  type="file"
                  id="imageUpload"
                  accept=".png, .jpg, .jpeg"
                />
                <label for="imageUpload" id=""
                  ><i class="profile-icon fa fa-upload"></i
                ></label>
              </div>
              <div class="avatar-preview">
                <div
                  id="imagePreview"
                  style="background-image: src('/images/profile.png')"
                ></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          Fist Name
          <input type="text" id="firstName" class="form-control" />
        </div>
        <div class="col-lg-6">
          Last Name
          <input type="text" id="lastName" class="form-control" />
        </div>

        <div class="col-lg-12">
          <br /><br />
          <select id="gender" class="gender form-control">
            <option value="1">Male</option>
            <option value="2">Female</option>
          </select>
          <br />
        </div>

        <div class="col-lg-6">
          Username
          <input type="text" id="username" class="form-control" />
        </div>
        <div class="col-lg-6 password">
          password
          <input type="text" id="password" class="form-control" />
        </div>
        <hr />
        <div class="col-lg-12">
          <hr />
        </div>
        <div class="col-lg-6 passowrd1">
          New Password
          <input type="password" id="password1" class="form-control" />
        </div>

        <div class="col-lg-6 passowrd2">
          Confirm the password
          <input type="password" id="password2" class="form-control" />
        </div>

        <div class="col-lg-6">
          <br />
          <br />
          <button class="btn btn-primary register">Register</button>
          <button class="btn btn-warning update">Update</button>
        </div>
      </div>
    </div>

    <!-- Large modal -->

    <!-- bootstrap v5 -->
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>

    <!-- Date Picker  -->
    <script src="dist/js/jquery.min.js"></script>
    <script src="dist/js/google-date-ui.js"></script>
    <!-- Sweet alert -->
    <script src="dist/js/sweetalert.mini.js"></script>
    <script src="dist/js/jquery.dataTables.min.js"></script>
    <!-- <script src="dist/js/dataTables.jqueryui.min.js"></script> -->
    <!-- <script src="dist/js/custom.js"></script> -->

    <script>
      $(document).ready(function () {
        const success = (message) => {
          swal(
            {
              title: "Success !",
              text: message,
              type: "success",
            },
            function () {
              window.location.replace($host_name + "/login");
            }
          );
        };

        const error = (message) => {
          swal("Ooops !", message, "error");
        };

        const warning = (message) => {
          swal("Ooops !", message, "warning");
        };

        let $host_name = "http://localhost:8080";
        const registerUser = () => {
          let user = {
            username: $("#username").val(),
            firstName: $("#firstName").val(),
            lastName: $("#lastName").val(),
            gender: $("#gender").val(),
            password: $("#password").val(),
            photo: $("#profilePictureInput").val(),
          };

          $.ajax({
            type: "POST",
            url: $host_name + "/register-user",
            dataType: "json",
            headers: { "Content-Type": "application/json", charset: "utf-8" },
            data: JSON.stringify(user),
            success: function (data) {
              success("You have successfully registered !");
            },
            error: function (xmlHttpRequest, textStatus, errorThrown) {
              if (xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0)
                warning("The server is down !");
              else warning("Username is already taken !");
              // else warning(JSON.parse(xmlHttpRequest.responseText).message);
            },
          });
        };

        const updateUser = () => {
          let user = {
            id: localStorage.getItem("user-id"),
            firstName: $("#firstName").val(),
            lastName: $("#lastName").val(),
            gender: $("#gender").val(),
            password: $("#password2").val(),
            photo: $("#profilePictureInput").val(),
          };

          if (
            $("#password2").val().length > 0 &&
            $("#password2").val() == $("#password1").val()
          ) {
            $.ajax({
              type: "POST",
              url: $host_name + "/update-user",
              dataType: "json",
              headers: { "Content-Type": "application/json", charset: "utf-8" },
              data: JSON.stringify(user),
              success: function (data) {
                success("Your profile successfully updated !");
              },
              error: function (xmlHttpRequest, textStatus, errorThrown) {
                if (
                  xmlHttpRequest.readyState == 0 ||
                  xmlHttpRequest.status == 0
                )
                  warning("The server is down !");
                else warning("Can update you profile !");
                // else warning(JSON.parse(xmlHttpRequest.responseText).message);
              },
            });
          } else {
            warning("the password does not match !");
          }
        };

        $(".register").click(function () {
          registerUser();
        });

        $(".update").click(function () {
          updateUser();
        });

        // image
        $(document).ready(function () {
          let currentImage = $("#profilePictureInput").val();
          let uri = currentImage != null ? currentImage : "";
          $("#imagePreview").css("background-image", "url(" + uri + ")");
        });

        function readURL(input) {
          if (input.files && input.files[0]) {
            var reader = new FileReader();
            $("#profilePictureInput").empty();
            reader.onload = function (e) {
              var profilePicLength = e.target.result;
              const profilePic = profilePicLength.split("base64,").pop();
              $("#imagePreview").css(
                "background-image",
                "url(" + e.target.result + ")"
              );
              $("#imagePreview").hide();
              $("#imagePreview").fadeIn(650);
              $("#profilePictureInput").val(
                `data:image/png;base64,${profilePic}`
              );
            };
            reader.readAsDataURL(input.files[0]);
          }
        }

        $("#imageUpload").change(function () {
          readURL(this);
        });
        //  End Image

        let user = localStorage.getItem("user-id");
        if (user != null) {
          $("#username").val(localStorage.getItem("user-username"));
          $("#firstName").val(localStorage.getItem("user-firstName"));
          $("#lastName").val(localStorage.getItem("user-lastName"));
          $("#gender").val(localStorage.getItem("user-gender"));
          $("#password").val(localStorage.getItem("user-password"));
          $("#profilePictureInput").val(localStorage.getItem("user-photo"));

          $(".registration-form-title").text("Settings - User Profile");
          $("#password").attr("readonly", true);
          $("#username").attr("readonly", true);
          $(".password").css("display", "none");
        } else {
          $("#password1").css("display", "none");
          $("#password2").css("display", "none");
        }
      });
    </script>
  </body>
</html>
